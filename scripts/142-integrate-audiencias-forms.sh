#!/bin/bash

# Script 142 - Integrar formul√°rios NewAudiencia e EditAudiencia com API real
# Sistema Erlene Advogados - Conectar formul√°rios com audienciasService
# Data: $(date +%Y-%m-%d)
# EXECUTE DENTRO DA PASTA: frontend/

echo "üìù Script 142 - Integrando formul√°rios de audi√™ncias com API real..."

# Verificar se estamos no diret√≥rio correto
if [ ! -f "package.json" ]; then
    echo "‚ùå Erro: Execute este script dentro da pasta frontend/"
    exit 1
fi

echo "1Ô∏è‚É£ Verificando arquivos dos formul√°rios..."

# Verificar se formul√°rios existem
if [ ! -f "src/components/audiencias/NewAudiencia.js" ]; then
    echo "‚ùå NewAudiencia.js n√£o encontrado"
    exit 1
fi

if [ ! -f "src/components/audiencias/EditAudiencia.js" ]; then
    echo "‚ùå EditAudiencia.js n√£o encontrado"
    exit 1
fi

echo "‚úÖ Formul√°rios encontrados"

echo "2Ô∏è‚É£ Fazendo backup dos formul√°rios..."

cp "src/components/audiencias/NewAudiencia.js" "src/components/audiencias/NewAudiencia.js.bak.142"
cp "src/components/audiencias/EditAudiencia.js" "src/components/audiencias/EditAudiencia.js.bak.142"

echo "‚úÖ Backups criados"

echo "3Ô∏è‚É£ Analisando uso atual do audienciasService nos formul√°rios..."

echo "üìã NewAudiencia.js - imports:"
grep -n "import.*audiencias" src/components/audiencias/NewAudiencia.js || echo "   Nenhum import de audienciasService encontrado"

echo ""
echo "üìã EditAudiencia.js - imports:"
grep -n "import.*audiencias" src/components/audiencias/EditAudiencia.js || echo "   Nenhum import de audienciasService encontrado"

echo ""
echo "üìã NewAudiencia.js - uso de service:"
grep -n "audienciasService" src/components/audiencias/NewAudiencia.js || echo "   Nenhum uso encontrado"

echo ""
echo "üìã EditAudiencia.js - uso de service:"
grep -n "audienciasService" src/components/audiencias/EditAudiencia.js || echo "   Nenhum uso encontrado"

echo "4Ô∏è‚É£ Integrando NewAudiencia.js com API real..."

# Verificar se j√° importa audienciasService
if ! grep -q "import.*audienciasService" src/components/audiencias/NewAudiencia.js; then
    echo "Adicionando import do audienciasService..."
    
    # Adicionar import ap√≥s os outros imports
    sed -i '/import.*@heroicons/a import audienciasService from "../../services/audienciasService";' src/components/audiencias/NewAudiencia.js
fi

# Substituir handleSubmit mockado por integra√ß√£o real
if grep -q "// Simular salvamento" src/components/audiencias/NewAudiencia.js; then
    echo "Substituindo salvamento mockado por API real..."
    
    # Criar nova implementa√ß√£o do handleSubmit
    cat > temp_new_handlesubmit.js << 'EOF'
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!validateForm()) return;
    
    setLoading(true);
    
    try {
      // Validar dados antes do envio
      const validacao = audienciasService.validarDadosAudiencia(formData);
      if (!validacao.valido) {
        setErrors(validacao.erros.reduce((acc, erro) => {
          const campo = erro.toLowerCase().includes('processo') ? 'processoId' :
                       erro.toLowerCase().includes('cliente') ? 'clienteId' :
                       erro.toLowerCase().includes('tipo') ? 'tipo' :
                       erro.toLowerCase().includes('data') ? 'data' :
                       erro.toLowerCase().includes('hora') ? 'hora' :
                       erro.toLowerCase().includes('local') ? 'local' :
                       erro.toLowerCase().includes('advogado') ? 'advogado' : 'geral';
          acc[campo] = erro;
          return acc;
        }, {}));
        return;
      }

      // Formatar dados para a API
      const dadosFormatados = audienciasService.formatarDadosParaAPI(formData);
      
      // Enviar para API
      const resultado = await audienciasService.criarAudiencia(dadosFormatados);
      
      if (resultado.success) {
        alert('Audi√™ncia agendada com sucesso!');
        navigate('/admin/audiencias');
      } else {
        alert('Erro ao agendar audi√™ncia: ' + resultado.error);
        
        // Tratar erros de valida√ß√£o do backend
        if (resultado.errors) {
          setErrors(resultado.errors);
        }
      }
    } catch (error) {
      console.error('Erro ao criar audi√™ncia:', error);
      alert('Erro inesperado ao agendar audi√™ncia');
    } finally {
      setLoading(false);
    }
  };
EOF

    # Substituir fun√ß√£o handleSubmit
    awk '
    BEGIN { in_handlesubmit = 0; skip_lines = 0 }
    
    /const handleSubmit = async \(e\) => \{/ {
        while ((getline line < "temp_new_handlesubmit.js") > 0) {
            print line
        }
        close("temp_new_handlesubmit.js")
        in_handlesubmit = 1
        skip_lines = 1
        next
    }
    
    in_handlesubmit && /^  \};$/ {
        in_handlesubmit = 0
        skip_lines = 0
        next
    }
    
    skip_lines { next }
    { print }
    ' src/components/audiencias/NewAudiencia.js > src/components/audiencias/NewAudiencia_temp.js
    
    mv src/components/audiencias/NewAudiencia_temp.js src/components/audiencias/NewAudiencia.js
    rm temp_new_handlesubmit.js
fi

echo "5Ô∏è‚É£ Integrando EditAudiencia.js com API real..."

# Verificar se j√° importa audienciasService
if ! grep -q "import.*audienciasService" src/components/audiencias/EditAudiencia.js; then
    echo "Adicionando import do audienciasService..."
    
    sed -i '/import.*@heroicons/a import audienciasService from "../../services/audienciasService";' src/components/audiencias/EditAudiencia.js
fi

# Substituir carregamento de dados mockados
if grep -q "const mockAudiencia" src/components/audiencias/EditAudiencia.js; then
    echo "Substituindo carregamento mockado por API real..."
    
    # Criar nova implementa√ß√£o do useEffect
    cat > temp_edit_useeffect.js << 'EOF'
  useEffect(() => {
    const carregarAudiencia = async () => {
      if (!id) return;
      
      setLoadingData(true);
      
      try {
        const resultado = await audienciasService.obterAudiencia(id);
        
        if (resultado.success && resultado.audiencia) {
          const audiencia = resultado.audiencia;
          
          // Formatar dados para o formul√°rio
          setFormData({
            tipo: audiencia.tipo || '',
            data: audiencia.data ? (audiencia.data.includes('T') ? audiencia.data.split('T')[0] : audiencia.data) : '',
            hora: audiencia.hora ? audiencia.hora.substring(0, 5) : '',
            local: audiencia.local || '',
            sala: audiencia.sala || '',
            endereco: audiencia.endereco || '',
            advogado: audiencia.advogado || '',
            juiz: audiencia.juiz || '',
            status: audiencia.status || 'agendada',
            observacoes: audiencia.observacoes || ''
          });
        } else {
          alert('Erro ao carregar audi√™ncia: ' + (resultado.error || 'Audi√™ncia n√£o encontrada'));
          navigate('/admin/audiencias');
        }
      } catch (error) {
        console.error('Erro ao carregar audi√™ncia:', error);
        alert('Erro ao carregar dados da audi√™ncia');
        navigate('/admin/audiencias');
      } finally {
        setLoadingData(false);
      }
    };

    carregarAudiencia();
  }, [id, navigate]);
EOF

    # Substituir useEffect
    awk '
    BEGIN { in_useeffect = 0; brace_count = 0 }
    
    /useEffect\(\(\) => \{/ {
        while ((getline line < "temp_edit_useeffect.js") > 0) {
            print line
        }
        close("temp_edit_useeffect.js")
        in_useeffect = 1
        brace_count = 1
        next
    }
    
    in_useeffect {
        gsub(/\{/, "", $0); brace_count += gsub(/\{/, "", $0)
        gsub(/\}/, "", $0); brace_count -= gsub(/\}/, "", $0)
        if (brace_count <= 0) {
            in_useeffect = 0
            next
        }
        next
    }
    
    { print }
    ' src/components/audiencias/EditAudiencia.js > src/components/audiencias/EditAudiencia_temp.js
    
    mv src/components/audiencias/EditAudiencia_temp.js src/components/audiencias/EditAudiencia.js
    rm temp_edit_useeffect.js
fi

# Substituir handleSubmit de edi√ß√£o
if grep -q "// Simular salvamento" src/components/audiencias/EditAudiencia.js; then
    echo "Substituindo salvamento de edi√ß√£o por API real..."
    
    cat > temp_edit_handlesubmit.js << 'EOF'
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!validateForm()) return;
    
    setLoading(true);
    
    try {
      // Formatar dados para a API
      const dadosFormatados = audienciasService.formatarDadosParaAPI(formData);
      
      // Atualizar via API
      const resultado = await audienciasService.atualizarAudiencia(id, dadosFormatados);
      
      if (resultado.success) {
        alert('Audi√™ncia atualizada com sucesso!');
        navigate('/admin/audiencias');
      } else {
        alert('Erro ao atualizar audi√™ncia: ' + resultado.error);
        
        if (resultado.errors) {
          setErrors(resultado.errors);
        }
      }
    } catch (error) {
      console.error('Erro ao atualizar audi√™ncia:', error);
      alert('Erro inesperado ao atualizar audi√™ncia');
    } finally {
      setLoading(false);
    }
  };
EOF

    # Substituir fun√ß√£o handleSubmit de edi√ß√£o
    awk '
    BEGIN { in_handlesubmit = 0; skip_lines = 0 }
    
    /const handleSubmit = async \(e\) => \{/ {
        while ((getline line < "temp_edit_handlesubmit.js") > 0) {
            print line
        }
        close("temp_edit_handlesubmit.js")
        in_handlesubmit = 1
        skip_lines = 1
        next
    }
    
    in_handlesubmit && /^  \};$/ {
        in_handlesubmit = 0
        skip_lines = 0
        next
    }
    
    skip_lines { next }
    { print }
    ' src/components/audiencias/EditAudiencia.js > src/components/audiencias/EditAudiencia_temp2.js
    
    mv src/components/audiencias/EditAudiencia_temp2.js src/components/audiencias/EditAudiencia.js
    rm temp_edit_handlesubmit.js
fi

echo "6Ô∏è‚É£ Verificando sintaxe dos formul√°rios..."

if node -c src/components/audiencias/NewAudiencia.js 2>/dev/null; then
    echo "‚úÖ NewAudiencia.js - sintaxe correta"
else
    echo "‚ùå NewAudiencia.js - erro de sintaxe"
    node -c src/components/audiencias/NewAudiencia.js
fi

if node -c src/components/audiencias/EditAudiencia.js 2>/dev/null; then
    echo "‚úÖ EditAudiencia.js - sintaxe correta" 
else
    echo "‚ùå EditAudiencia.js - erro de sintaxe"
    node -c src/components/audiencias/EditAudiencia.js
fi

echo ""
echo "‚úÖ Script 142 conclu√≠do!"
echo ""
echo "üîß INTEGRA√á√ïES REALIZADAS:"
echo "   ‚úÖ NewAudiencia.js conectado com audienciasService"
echo "   ‚úÖ EditAudiencia.js conectado com audienciasService"
echo "   ‚úÖ Dados mockados substitu√≠dos por API real"
echo "   ‚úÖ Valida√ß√£o e formata√ß√£o integradas"
echo ""
echo "üìã FUNCIONALIDADES:"
echo "   ‚Ä¢ Criar nova audi√™ncia via API"
echo "   ‚Ä¢ Carregar dados para edi√ß√£o via API"
echo "   ‚Ä¢ Atualizar audi√™ncia existente via API"
echo "   ‚Ä¢ Valida√ß√£o de dados antes do envio"
echo "   ‚Ä¢ Tratamento de erros do backend"
echo ""
echo "üß™ TESTE:"
echo "   1. Ir para /admin/audiencias/nova"
echo "   2. Preencher formul√°rio e testar cria√ß√£o"
echo "   3. Clicar em 'Editar' numa audi√™ncia existente"
echo "   4. Testar atualiza√ß√£o dos dados"
echo ""
echo "üîÑ Se houver erro:"
echo "   Restaurar backups: .bak.142"