#!/bin/bash

# Script 132 - Corrigir fun√ß√£o handleCurrencyChange duplicada (URGENTE)
# Sistema Erlene Advogados - Resolver erro "Identifier 'handleCurrencyChange' has already been declared"
# EXECUTAR DENTRO DA PASTA: frontend/

echo "üîß Script 132 - Corrigindo fun√ß√£o handleCurrencyChange duplicada..."

# Verificar se estamos no diret√≥rio correto
if [ ! -f "package.json" ]; then
    echo "‚ùå Erro: Execute este script dentro da pasta frontend/"
    echo "üìç Comando correto:"
    echo "   cd frontend"
    echo "   chmod +x 132-fix-duplicate-function.sh && ./132-fix-duplicate-function.sh"
    exit 1
fi

echo "1Ô∏è‚É£ DIAGN√ìSTICO DO PROBLEMA ESPEC√çFICO:"
echo "   ‚Ä¢ NewProcess.js linha 217: fun√ß√£o handleCurrencyChange declarada duas vezes"
echo "   ‚Ä¢ Erro: Identifier 'handleCurrencyChange' has already been declared"
echo "   ‚Ä¢ Causa: script anterior deixou c√≥digo duplicado"
echo "   ‚Ä¢ Solu√ß√£o: remover duplica√ß√£o e deixar apenas uma vers√£o correta"

echo ""
echo "2Ô∏è‚É£ Verificando arquivo NewProcess.js..."

# Verificar se o arquivo existe
if [ ! -f "src/components/processes/NewProcess.js" ]; then
    echo "‚ùå Arquivo NewProcess.js n√£o encontrado"
    exit 1
fi

# Contar quantas vezes handleCurrencyChange aparece
duplicate_count=$(grep -c "const handleCurrencyChange" src/components/processes/NewProcess.js)
echo "üìä Fun√ß√£o handleCurrencyChange encontrada $duplicate_count vezes"

if [ "$duplicate_count" -gt 1 ]; then
    echo "‚ùå Confirmado: fun√ß√£o duplicada detected"
    echo "üîß Aplicando corre√ß√£o..."
else
    echo "‚úÖ Nenhuma duplica√ß√£o encontrada, verificando outros problemas..."
fi

echo ""
echo "3Ô∏è‚É£ Fazendo backup do arquivo atual..."

# Criar backup
cp src/components/processes/NewProcess.js src/components/processes/NewProcess.js.backup.132
echo "‚úÖ Backup criado: NewProcess.js.backup.132"

echo ""
echo "4Ô∏è‚É£ Removendo fun√ß√£o duplicada e linhas problem√°ticas..."

# Criar arquivo tempor√°rio limpo
temp_file=$(mktemp)

# Estrat√©gia: remover TODAS as fun√ß√µes de formata√ß√£o e recriar apenas uma vez
awk '
BEGIN { 
    in_currency_function = 0
    in_handle_currency = 0
    in_currency_to_number = 0
    skip_line = 0
    functions_added = 0
}

# Detectar in√≠cio das fun√ß√µes problem√°ticas
/^[[:space:]]*const formatCurrency = / { 
    in_currency_function = 1
    skip_line = 1
    next
}

/^[[:space:]]*const handleCurrencyChange = / { 
    in_handle_currency = 1
    skip_line = 1
    next
}

/^[[:space:]]*const currencyToNumber = / { 
    in_currency_to_number = 1
    skip_line = 1
    next
}

# Detectar fim das fun√ß√µes (linha com }; ou };)
/^[[:space:]]*};?[[:space:]]*$/ {
    if (in_currency_function || in_handle_currency || in_currency_to_number) {
        in_currency_function = 0
        in_handle_currency = 0
        in_currency_to_number = 0
        skip_line = 1
        next
    }
}

# Inserir fun√ß√µes corretas ap√≥s useState declarations
/^[[:space:]]*const \[errors, setErrors\] = useState\(\{\}\);/ {
    print $0
    if (functions_added == 0) {
        print ""
        print "  // Fun√ß√µes de formata√ß√£o de moeda (vers√£o corrigida)"
        print "  const formatCurrency = (value) => {"
        print "    if (!value) return \"\";"
        print "    "
        print "    // Remove tudo exceto n√∫meros"
        print "    const numbers = value.replace(/\\D/g, \"\");"
        print "    "
        print "    if (!numbers) return \"\";"
        print "    "
        print "    // Converte para n√∫mero com 2 casas decimais"
        print "    const amount = parseInt(numbers) / 100;"
        print "    "
        print "    return new Intl.NumberFormat(\"pt-BR\", {"
        print "      style: \"currency\","
        print "      currency: \"BRL\""
        print "    }).format(amount);"
        print "  };"
        print ""
        print "  const handleCurrencyChange = (e) => {"
        print "    const formatted = formatCurrency(e.target.value);"
        print "    setFormData(prev => ({"
        print "      ...prev,"
        print "      valor_causa: formatted"
        print "    }));"
        print "  };"
        print ""
        print "  // Fun√ß√£o para converter moeda formatada para n√∫mero"
        print "  const currencyToNumber = (currencyString) => {"
        print "    if (!currencyString) return null;"
        print "    "
        print "    // Remove \"R$\", espa√ßos, pontos (milhares) e converte v√≠rgula para ponto"
        print "    const numberStr = currencyString"
        print "      .replace(/R\\$\\s?/g, \"\")"
        print "      .replace(/\\./g, \"\")"
        print "      .replace(/,/g, \".\");"
        print "    "
        print "    const number = parseFloat(numberStr);"
        print "    return isNaN(number) ? null : number;"
        print "  };"
        print ""
        functions_added = 1
    }
    next
}

# Pular linhas das fun√ß√µes duplicadas
{
    if (!skip_line && !in_currency_function && !in_handle_currency && !in_currency_to_number) {
        print $0
    }
    skip_line = 0
}
' src/components/processes/NewProcess.js > "$temp_file"

# Verificar se o arquivo tempor√°rio foi criado com sucesso
if [ -s "$temp_file" ]; then
    # Substituir o arquivo original
    cp "$temp_file" src/components/processes/NewProcess.js
    echo "‚úÖ Fun√ß√£o duplicada removida e vers√£o corrigida adicionada"
else
    echo "‚ùå Erro ao processar arquivo"
    rm -f "$temp_file"
    exit 1
fi

# Limpar arquivo tempor√°rio
rm -f "$temp_file"

echo ""
echo "5Ô∏è‚É£ Corrigindo linha do submit que pode estar malformada..."

# Corrigir a linha problem√°tica do submit
sed -i '/valor_causa: currencyToNumber(formData\.valor_causa),/,/parseFloat.*null,/ {
    /valor_causa: currencyToNumber(formData\.valor_causa),/ {
        s/.*/        valor_causa: currencyToNumber(formData.valor_causa),/
        N
        d
    }
}' src/components/processes/NewProcess.js

echo "‚úÖ Linha do submit corrigida"

echo ""
echo "6Ô∏è‚É£ Verificando se o problema foi resolvido..."

# Verificar sintaxe com node
syntax_check=$(node -c src/components/processes/NewProcess.js 2>&1)
if [ $? -eq 0 ]; then
    echo "‚úÖ Sintaxe JavaScript v√°lida!"
else
    echo "‚ùå Ainda h√° erros de sintaxe:"
    echo "$syntax_check"
    echo ""
    echo "üîß Aplicando corre√ß√£o adicional..."
    
    # Se ainda h√° erro, usar abordagem mais conservadora
    if [ -f "src/components/processes/NewProcess.js.backup.130" ]; then
        echo "Restaurando backup 130 e aplicando corre√ß√£o manual..."
        cp src/components/processes/NewProcess.js.backup.130 src/components/processes/NewProcess.js
        
        # Adicionar apenas as fun√ß√µes necess√°rias ap√≥s as declara√ß√µes useState
        sed -i '/const \[errors, setErrors\] = useState({});/a\
\
  // Fun√ß√µes de formata√ß√£o de moeda\
  const formatCurrency = (value) => {\
    if (!value) return "";\
    const numbers = value.replace(/\\D/g, "");\
    if (!numbers) return "";\
    const amount = parseInt(numbers) / 100;\
    return new Intl.NumberFormat("pt-BR", {\
      style: "currency",\
      currency: "BRL"\
    }).format(amount);\
  };\
\
  const handleCurrencyChange = (e) => {\
    const formatted = formatCurrency(e.target.value);\
    setFormData(prev => ({\
      ...prev,\
      valor_causa: formatted\
    }));\
  };\
\
  const currencyToNumber = (currencyString) => {\
    if (!currencyString) return null;\
    const numberStr = currencyString\
      .replace(/R\\$\\s?/g, "")\
      .replace(/\\./g, "")\
      .replace(/,/g, ".");\
    const number = parseFloat(numberStr);\
    return isNaN(number) ? null : number;\
  };' src/components/processes/NewProcess.js

        # Corrigir a linha de submit
        sed -i 's/valor_causa: formData\.valor_causa ?.*/valor_causa: currencyToNumber(formData.valor_causa),/' src/components/processes/NewProcess.js
        
        echo "‚úÖ Corre√ß√£o manual aplicada"
    fi
fi

echo ""
echo "7Ô∏è‚É£ Valida√ß√£o final..."

# Verificar novamente
final_check=$(node -c src/components/processes/NewProcess.js 2>&1)
if [ $? -eq 0 ]; then
    echo "‚úÖ NewProcess.js corrigido com sucesso!"
else
    echo "‚ùå Ainda h√° problemas. Erro:"
    echo "$final_check"
    echo ""
    echo "üö® A√á√ÉO MANUAL NECESS√ÅRIA:"
    echo "1. Abra src/components/processes/NewProcess.js"
    echo "2. Procure por 'handleCurrencyChange' duplicado"
    echo "3. Remova uma das declara√ß√µes"
    echo "4. Salve o arquivo"
    exit 1
fi

# Verificar quantas fun√ß√µes restaram
final_count=$(grep -c "const handleCurrencyChange" src/components/processes/NewProcess.js)
echo "üìä Fun√ß√£o handleCurrencyChange aparece $final_count vez(es) - deve ser 1"

if [ "$final_count" -eq 1 ]; then
    echo "‚úÖ N√∫mero correto de fun√ß√µes"
else
    echo "‚ö†Ô∏è Ainda pode haver duplica√ß√µes"
fi

echo ""
echo "8Ô∏è‚É£ Testando formata√ß√£o de moeda..."

# Criar teste r√°pido
cat > test-newprocess-functions.js << 'EOF'
// Teste das fun√ß√µes do NewProcess

const formatCurrency = (value) => {
  if (!value) return "";
  const numbers = value.replace(/\D/g, "");
  if (!numbers) return "";
  const amount = parseInt(numbers) / 100;
  return new Intl.NumberFormat("pt-BR", {
    style: "currency",
    currency: "BRL"
  }).format(amount);
};

const currencyToNumber = (currencyString) => {
  if (!currencyString) return null;
  const numberStr = currencyString
    .replace(/R\$\s?/g, "")
    .replace(/\./g, "")
    .replace(/,/g, ".");
  const number = parseFloat(numberStr);
  return isNaN(number) ? null : number;
};

console.log("=== TESTE NEWPROCESS ===");
console.log("formatCurrency('12345') ->", formatCurrency('12345'));
console.log("currencyToNumber('R$ 12.345,67') ->", currencyToNumber('R$ 12.345,67'));
console.log("‚úÖ Fun√ß√µes working correctly!");
EOF

node test-newprocess-functions.js
rm test-newprocess-functions.js

echo ""
if [ "$final_count" -eq 1 ] && [ $? -eq 0 ]; then
    echo "‚úÖ SCRIPT 132 CONCLU√çDO COM SUCESSO!"
    echo ""
    echo "üîß PROBLEMA RESOLVIDO:"
    echo "   ‚ùå Antes: handleCurrencyChange declarado 2+ vezes (erro de sintaxe)"
    echo "   ‚úÖ Agora: handleCurrencyChange declarado 1 vez (funcionando)"
    echo ""
    echo "üéØ FUN√á√ïES CORRIGIDAS:"
    echo "   ‚úÖ formatCurrency() - formata√ß√£o durante digita√ß√£o"
    echo "   ‚úÖ handleCurrencyChange() - handler do input (SEM DUPLICA√á√ÉO)"
    echo "   ‚úÖ currencyToNumber() - converte moeda BR para n√∫mero"
    echo ""
    echo "üß™ TESTE AGORA:"
    echo "   1. Ctrl+C para parar o servidor se estiver rodando"
    echo "   2. npm start"
    echo "   3. Acesse /admin/processos/novo"
    echo "   4. Teste o campo 'Valor da Causa'"
    echo ""
    echo "üìÅ ARQUIVOS AFETADOS:"
    echo "   ‚úÖ src/components/processes/NewProcess.js (corrigido)"
    echo "   ‚úÖ Backup criado: NewProcess.js.backup.132"
else
    echo "‚ùå SCRIPT 132 FALHOU"
    echo ""
    echo "üîß SOLU√á√ïES MANUAIS:"
    echo "   1. Abra o arquivo: src/components/processes/NewProcess.js"
    echo "   2. Procure por 'const handleCurrencyChange' (deve aparecer s√≥ 1 vez)"
    echo "   3. Se aparecer 2+ vezes, delete as duplicatas"
    echo "   4. Mantenha apenas uma vers√£o da fun√ß√£o"
    echo "   5. Salve e teste novamente"
    echo ""
    echo "üìã OU RESTORE BACKUP:"
    echo "   cp src/components/processes/NewProcess.js.backup.130 src/components/processes/NewProcess.js"
fi